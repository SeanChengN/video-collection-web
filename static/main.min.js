async function safeApiFetch(e,t={}){try{const n=await fetch(e,t);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}catch(e){throw console.error("API request failed:",e),e}}window.onerror=function(e,t,n,a,i){return console.error("Error: ",e,"\nURL: ",t,"\nLine: ",n,"\nColumn: ",a,"\nError object: ",i),!1};const cache=new Map;async function cachedFetch(e,t={}){const n=e+JSON.stringify(t);if(cache.has(n))return cache.get(n);const a=await safeApiFetch(e,t);return cache.set(n,a),a}const imageObserver=new IntersectionObserver(((e,t)=>{e.forEach((e=>{if(e.isIntersecting){const n=e.target;n.src&&"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"!==n.src||(n.src=n.dataset.src,t.unobserve(n))}}))}),{rootMargin:"50px 0px",threshold:.1}),ModalManager={activeModals:new Map,minimizedModals:new Set,baseZIndex:1e3,open(e){const t=document.getElementById(e);t&&requestAnimationFrame((()=>{const n=t.querySelector(".modal-card"),a=this.getToolbarButton(e);if(a&&this.minimizedModals.has(e))return void this.restoreModal(e);const i=document.querySelectorAll(".modal"),o=Math.max(this.baseZIndex,...Array.from(i).map((e=>parseInt(window.getComputedStyle(e).zIndex)||0)))+10;if(t.style.zIndex=o,t.classList.add("is-active"),n){n.style.visibility="hidden",n.style.position="absolute",n.style.transform="none",n.style.margin="0",n.style.maxHeight="90vh",n.style.overflowY="auto";const e=window.innerWidth,t=window.innerHeight,a=n.offsetWidth,i=n.offsetHeight;n.style.left=`${Math.max(0,(e-a)/2)}px`,n.style.top=`${Math.max(0,(t-i)/2)}px`,n.style.visibility="visible"}a&&a.classList.add("is-active"),this.activeModals.set(e,{isMinimized:!1,zIndex:o})}))},minimize(e){const t=document.getElementById(e),n=t.querySelector(".modal-card"),a=this.getToolbarButton(e);if(t&&a){const i=n.getBoundingClientRect();this.activeModals.set(e,{isMinimized:!0,rect:i});const o=a.getBoundingClientRect();n.style.transform="translate3d(0, 0, 0)",n.classList.add("minimizing"),requestAnimationFrame((()=>{const e=o.width/i.width,t=o.height/i.height,a=o.left-i.left,s=o.top-i.top;n.style.transform=`translate3d(${a}px, ${s}px, 0) scale(${e}, ${t})`,n.style.opacity="0"})),setTimeout((()=>{t.classList.remove("is-active"),n.classList.remove("minimizing"),this.minimizedModals.add(e)}),300)}},restoreModal(e){const t=document.getElementById(e),n=t.querySelector(".modal-card"),a=this.activeModals.get(e);if(t&&a&&a.rect){const i=document.querySelectorAll(".modal"),o=Math.max(this.baseZIndex,...Array.from(i).map((e=>parseInt(window.getComputedStyle(e).zIndex)||0)))+10;t.style.zIndex=o,t.classList.add("is-active"),n.classList.add("minimizing");const s=this.getToolbarButton(e).getBoundingClientRect();requestAnimationFrame((()=>{n.style.transform=`translate3d(${s.left-a.rect.left}px, ${s.top-a.rect.top}px, 0) scale(${s.width/a.rect.width}, ${s.height/a.rect.height})`,n.style.opacity="0",n.offsetHeight,requestAnimationFrame((()=>{n.style.transform="translate3d(0, 0, 0)",n.style.opacity="1"}))})),setTimeout((()=>{n.classList.remove("minimizing"),this.minimizedModals.delete(e),this.activeModals.set(e,{isMinimized:!1,zIndex:o,rect:a.rect})}),300)}},close(e){const t=document.getElementById(e);if(t){t.classList.remove("is-active");const n=this.getToolbarButton(e);n&&n.classList.remove("is-active")}this.activeModals.delete(e),this.minimizedModals.delete(e)},getToolbarButton(e){const t={duplicateModal:'[onclick*="openDuplicateModal"]',jackettModal:'[onclick*="openJackettModal"]',wtlModal:'[onclick*="openWtlModal"]',thunderModal:'[onclick*="openThunderModal"]',embyModal:'[onclick*="openEmbyModal"]',settingsModal:'[onclick*="openSettingsModal"]'}[e];return t?document.querySelector(t):null}};function minimizeModal(e){ModalManager.minimize(e)}function loadDeferredStyles(){["/static/styles.min.css","https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"].forEach((e=>{const t=document.createElement("link");t.rel="stylesheet",t.href=e,document.head.appendChild(t)}))}window.addEventListener?window.addEventListener("load",loadDeferredStyles):window.attachEvent("onload",loadDeferredStyles);const itemsPerPage=10;let currentPage=1,totalPages=0,allMovies=[];const DEFAULT_COLUMN_WIDTHS={title:"20%",recommended:"8%",review:"35%",tags:"20%",date:"12%",action:"5%"};let serviceConfig={};fetch("/get_services_config").then((e=>e.json())).then((e=>{serviceConfig=e}));let zIndexCounter=1e3;function makeDraggable(e){const t=e.querySelector(".modal-card"),n=e.querySelector(".modal-card-head");let a,i,o,s,r=!1,l=null;function c(l){if(!l.target.closest(".modal-card-controls")&&(l.target===n||l.target.closest(".modal-card-head"))){r=!0;const n=t.getBoundingClientRect();o=n.left,s=n.top,a=l.clientX-o,i=l.clientY-s,t.classList.add("dragging"),document.body.style.cursor="move",zIndexCounter+=1,e.style.zIndex=zIndexCounter,t.style.zIndex=zIndexCounter}}function d(e){if(!r)return;e.preventDefault();const n=e.clientX-a,c=e.clientY-i;o=n,s=c,l&&cancelAnimationFrame(l),l=requestAnimationFrame((()=>{t.style.position="fixed",t.style.left=`${n}px`,t.style.top=`${c}px`}))}function m(){r&&(r=!1,document.body.style.cursor="",t.classList.remove("dragging"),l&&(cancelAnimationFrame(l),l=null))}return e.addEventListener("mousedown",(()=>{zIndexCounter+=1,e.style.zIndex=zIndexCounter,t.style.zIndex=zIndexCounter})),n.addEventListener("mousedown",c,{passive:!1}),document.addEventListener("mousemove",d,{passive:!1}),document.addEventListener("mouseup",m,{passive:!0}),function(){n.removeEventListener("mousedown",c),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",m),l&&cancelAnimationFrame(l)}}function openDuplicateModal(){ModalManager.minimizedModals.has("duplicateModal")?ModalManager.restoreModal("duplicateModal"):ModalManager.open("duplicateModal")}function closeDuplicateModal(){ModalManager.close("duplicateModal")}function checkDuplicates(){const e=document.getElementById("duplicate-input"),t=document.getElementById("check-result"),n=e.value.split("\n").filter((e=>e.trim()));if(0===n.length)return void(t.innerHTML='<span class="has-text-danger">请输入电影列表</span>');const a=document.querySelector("#duplicateModal .button"),i=a.textContent;a.textContent="核对中...",a.disabled=!0,t.innerHTML='<span class="has-text-info">正在核对...</span>';const o=n.map((e=>e.trim().split(" ")[0]));fetch("/check_duplicates",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({titles:o})}).then((e=>e.json())).then((a=>{if(a.success){const i=a.duplicates.length,s=n.filter(((e,t)=>!a.duplicates.includes(o[t])));e.value=s.join("\n"),t.innerHTML=`\n                <div class="notification is-success">\n                    <p>核对完成！</p>\n                    <p>发现 <strong>${i}</strong> 个重复项</p>\n                    <p>剩余 <strong>${s.length}</strong> 个未收录项</p>\n                </div>\n            `}})).catch((e=>{t.innerHTML='<div class="notification is-danger is-light">核对过程出错，请重试</div>',console.error("Error:",e)})).finally((()=>{a.textContent=i,a.disabled=!1}))}function openEmbyModal(){ModalManager.minimizedModals.has("embyModal")?ModalManager.restoreModal("embyModal"):ModalManager.open("embyModal")}function closeEmbyModal(){ModalManager.close("embyModal")}function searchEmby(){const e=document.getElementById("emby-search-input").value,t=document.getElementById("emby-results");e.trim()?(t.innerHTML='<div class="notification is-info">正在搜索...</div>',fetch(`${serviceConfig.emby_server_url}/emby/Items?Recursive=true&IncludeItemTypes=Movie&NameStartsWith=${encodeURIComponent(e)}&api_key=${serviceConfig.emby_api_key}`).then((e=>e.json())).then((e=>{if(0===e.Items.length)return void(t.innerHTML='<div class="notification is-info">未找到相关影片</div>');const n=document.createDocumentFragment(),a=document.createElement("div");a.className="columns is-multiline",e.Items.forEach((e=>{const t=document.createElement("div");t.className="column is-one-fifth",t.innerHTML=`\n                    <div class="card movie-card">\n                        <div class="card-image">\n                            <figure class="image is-2by3">\n                                <img data-src="${serviceConfig.emby_server_url}/emby/Items/${e.Id}/Images/Primary?tag=${e.ImageTags.Primary}&api_key=${serviceConfig.emby_api_key}" \n                                     alt="${e.Name}"\n                                     src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">\n                                <div class="runtime-badge">${formatRuntime(e.RunTimeTicks)}</div>\n                            </figure>\n                        </div>\n                        <div class="card-content fixed-height">\n                            <p class="title is-6 movie-title" data-full-title="${e.Name}">${e.Name}</p>\n                        </div>\n                    </div>\n                `;const n=t.querySelector("img");imageObserver.observe(n),a.appendChild(t)})),n.appendChild(a),t.innerHTML="",t.appendChild(n)})).catch((e=>{t.innerHTML='<div class="notification is-danger">搜索出错，请稍后重试</div>',console.error("Search error:",e)}))):t.innerHTML='<div class="notification is-warning">请输入搜索内容</div>'}function formatRuntime(e){if(!e)return"";const t=Math.floor(e/6e8),n=Math.floor(t/60),a=t%60;return n>0?`${n}时${a}分`:`${a}分钟`}function openJackettModal(){ModalManager.minimizedModals.has("jackettModal")?ModalManager.restoreModal("jackettModal"):(ModalManager.open("jackettModal"),document.querySelector("#jackettModal iframe").src=`${serviceConfig.jackett_url}/UI/Dashboard#search`)}function closeJackettModal(){ModalManager.close("jackettModal")}function openThunderModal(){ModalManager.minimizedModals.has("thunderModal")?ModalManager.restoreModal("thunderModal"):(ModalManager.open("thunderModal"),document.querySelector("#thunderModal iframe").src=serviceConfig.thunder_url)}function closeThunderModal(){ModalManager.close("thunderModal")}function openWtlModal(){ModalManager.minimizedModals.has("wtlModal")?ModalManager.restoreModal("wtlModal"):(ModalManager.open("wtlModal"),document.getElementById("wtl-input").value="",document.getElementById("wtl-results").innerHTML="")}function closeWtlModal(){ModalManager.close("wtlModal")}function searchWtl(){const e=document.getElementById("wtl-input").value,t=document.getElementById("wtl-results");e.trim()?(t.innerHTML='<div class="notification is-info">正在查询...</div>',fetch(`https://whatslink.info/api/v1/link?url=${encodeURIComponent(e)}`).then((e=>e.json())).then((e=>{t.innerHTML=`\n                <div class="box">\n                    <div class="content">\n                        <p><strong>文件类型:</strong> ${e.file_type}</p>\n                        <p><strong>资源名称:</strong> ${e.name}</p>\n                        <p><strong>总文件大小:</strong> ${formatFileSize(e.size)}</p>\n                        <p><strong>文件数量:</strong> ${e.count}</p>\n                    </div>\n                    ${renderScreenshots(e.screenshots)}\n                </div>\n            `})).catch((e=>{t.innerHTML='<div class="notification is-danger">查询失败，请检查链接是否正确</div>'}))):t.innerHTML='<div class="notification is-warning">请输入链接</div>'}function formatFileSize(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB","TB"][t]}function renderScreenshots(e){return e&&0!==e.length?`\n        <div class="screenshots">\n            ${e.map((e=>`\n                <div class="screenshot-item">\n                    <img src="${e.screenshot}" alt="截图">\n                </div>\n            `)).join("")}\n        </div>\n    `:""}function formatTime(e){return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}document.addEventListener("DOMContentLoaded",(()=>{["duplicateModal","jackettModal","wtlModal","thunderModal","embyModal","editModal","settingsModal"].forEach((e=>{makeDraggable(document.getElementById(e))}))}));let editingItemId=null;function openSettingsModal(){ModalManager.open("settingsModal"),loadSettings()}function closeSettingsModal(){ModalManager.close("settingsModal")}function loadSettings(){loadSettingsTags(),loadSettingsRatingDimensions()}function startEdit(e){const t=e.closest("tr"),n=t.querySelector(".tag-name, .rating-name"),a=t.querySelector(".edit-form");n.style.display="none",a.style.display="flex",a.querySelector("input").focus()}function cancelEdit(e){const t=e.closest("tr"),n=t.querySelector(".tag-name, .rating-name"),a=t.querySelector(".edit-form");n.style.display="block",a.style.display="none"}function saveTagEdit(e,t){const n=e.closest("tr"),a=n.querySelector("input"),i=a.value.trim(),o=n.querySelector(".tag-name");i&&i!==t?fetch("/update_tag",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({old_name:t,new_name:i})}).then((e=>e.json())).then((t=>{if(t.success){o.textContent=i,a.value=i;n.querySelector(".edit-form button").setAttribute("onclick",`saveTagEdit(this, '${i}')`),cancelEdit(e)}else alert(t.message||"更新失败")})).catch((e=>{console.error("Error:",e),alert("更新失败："+e.message)})):cancelEdit(e)}function saveRatingEdit(e,t){const n=e.closest("tr"),a=n.querySelector("input"),i=a.value.trim(),o=n.querySelector(".rating-name");i&&i!==t?fetch("/update_rating_dimension",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({old_name:t,new_name:i})}).then((e=>e.json())).then((t=>{if(t.success){o.textContent=i,a.value=i;n.querySelector(".edit-form button").setAttribute("onclick",`saveRatingEdit(this, '${i}')`),cancelEdit(e)}else alert(t.message||"更新失败")})).catch((e=>{console.error("Error:",e),alert("更新失败："+e.message)})):cancelEdit(e)}function addNewTag(){const e=document.getElementById("newTagInput"),t=e.value.trim();t?fetch("/add_tag",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t})}).then((e=>e.json())).then((t=>{t.success?(e.value="",loadSettings(),loadTags()):alert(t.message||"添加失败")})).catch((e=>{console.error("Error:",e),alert("添加失败")})):alert("请输入标签名称")}function addNewRating(){const e=document.getElementById("newRatingInput"),t=e.value.trim();t?fetch("/add_rating_dimension",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t})}).then((e=>e.json())).then((t=>{t.success?(e.value="",loadSettings()):alert(t.message||"添加失败")})).catch((e=>{console.error("Error:",e),alert("添加失败")})):alert("请输入评分维度名称")}function loadSettingsTags(){fetch("/get_tags").then((e=>e.json())).then((e=>{if(e.success){document.getElementById("tagsList").innerHTML=e.data.map((e=>`\n                    <tr>\n                        <td>\n                            <div class="item-content">\n                                <div class="tag-name">${e}</div>\n                                <div class="edit-form">\n                                    <input type="text" class="input" value="${e}">\n                                    <button class="button is-success is-small save-btn-small" onclick="saveTagEdit(this, '${e}')">\n                                        <span class="icon">\n                                            <svg width="10" height="10" fill="currentColor" stroke="none" aria-label="保存">\n                                                <use href="/static/sprite.svg#save-btn-icon"></use>\n                                            </svg>\n                                        </span>\n                                        <span>保存</span>\n                                    </button>\n                                    <button class="button is-light is-small" onclick="cancelEdit(this)">取消</button>\n                                </div>\n                            </div>\n                        </td>\n                        <td>\n                            <button class="button is-small is-info" onclick="startEdit(this)">编辑</button>\n                        </td>\n                    </tr>\n                `)).join("")}}))}function loadSettingsRatingDimensions(){fetch("/get_ratings_dimensions").then((e=>e.json())).then((e=>{if(e.success){document.getElementById("ratingsList").innerHTML=e.dimensions.map((e=>`\n                    <tr>\n                        <td>\n                            <div class="item-content">\n                                <div class="rating-name">${e.name}</div>\n                                <div class="edit-form">\n                                    <input type="text" class="input" value="${e.name}">\n                                    <button class="button is-success is-small save-btn-small" onclick="saveRatingEdit(this, '${e.name}')">\n                                        <span class="icon">\n                                            <svg width="10" height="10" fill="currentColor" stroke="none" aria-label="保存">\n                                                <use href="/static/sprite.svg#save-btn-icon"></use>\n                                            </svg>\n                                        </span>\n                                        <span>保存</span>\n                                    </button>\n                                    <button class="button is-light is-small" onclick="cancelEdit(this)">取消</button>\n                                </div>\n                            </div>\n                        </td>\n                        <td>\n                            <button class="button is-small is-info" onclick="startEdit(this)">编辑</button>\n                        </td>\n                    </tr>\n                `)).join("")}}))}function getStoredColumnWidths(){const e=localStorage.getItem("tableColumnWidths");return e?JSON.parse(e):{title:"20%",recommended:"8%",review:"45%",tags:"22%",ratings:"8%",action:"7%"}}function loadTags(){fetch("/get_tags").then((e=>e.json())).then((e=>{if(e.success){const t=document.getElementById("add-tags");t.innerHTML="",e.data.forEach((e=>{const n=document.createElement("span");n.className="tag",n.textContent=e,n.onclick=()=>toggleTag(n),t.appendChild(n)}))}}))}function toggleTag(e){e.classList.toggle("is-selected")}document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelector(".settings-tabs"),t=document.querySelectorAll(".settings-content");e.addEventListener("click",(n=>{const a=n.target.closest("[data-tab]");if(!a)return;e.querySelectorAll("li").forEach((e=>e.classList.remove("is-active"))),a.classList.add("is-active");const i=a.dataset.tab+"Settings";t.forEach((e=>{e.style.display=e.id===i?"":"none"}))}))}));const debounce=(e,t)=>{let n;return(...a)=>{clearTimeout(n),n=setTimeout((()=>e.apply(this,a)),t)}};function loadFilters(){fetch("/get_ratings_dimensions").then((e=>e.json())).then((e=>{if(e.success){const t=document.getElementById("rating-dimension-filter");t.innerHTML='<option value="">全部维度</option>',e.dimensions.forEach((e=>{const n=document.createElement("option");n.value=e.name,n.textContent=e.name,t.appendChild(n)}))}})).catch((e=>{console.error("加载评分维度失败:",e)})),fetch("/get_tags").then((e=>e.json())).then((e=>{if(e.success){const t=document.getElementById("tags-filter");t.innerHTML="",e.data.forEach((e=>{const n=document.createElement("span");n.className="tag",n.textContent=e,n.onclick=()=>toggleFilterTag(n),t.appendChild(n)}))}})).catch((e=>{console.error("加载标签失败:",e)}))}function toggleFilterTag(e){e.classList.toggle("is-selected"),searchMovies()}function getSelectedTags(){const e=document.getElementById("tags-filter");return Array.from(e.getElementsByClassName("is-selected")).map((e=>e.textContent))}function searchMovies(){const e=document.getElementById("search-input").value.trim(),t=document.getElementById("rating-dimension-filter").value,n=document.getElementById("min-rating-filter").value,a=getSelectedTags(),i=document.getElementById("search-message"),o=document.getElementById("search-results"),s=new URLSearchParams;e&&s.append("title",e),t&&s.append("rating_dimension",t),n&&s.append("min_rating",n),a.length>0&&s.append("tags",a.join(","));const r=`/search?${s.toString()}`;fetch(r).then((e=>{if(!e.ok)throw new Error(`HTTP status: ${e.status}`);return e.json()})).then((e=>{if(!e)throw new Error("No result returned from server");if(e.success){let s=e.data;if(a.length>0&&(s=s.filter((e=>{const t=e.tag_names.split(", ");return a.every((e=>t.includes(e)))}))),n){const e=parseInt(n);s=s.filter((n=>{const a=n.ratings_display||{};if(t)return a[t]>=e;{const t=Object.values(a);return t.length>0&&t.every((t=>t>=e))}}))}if(allMovies=s,totalPages=Math.ceil(allMovies.length/10),0===allMovies.length)return i.innerHTML='<div class="notification is-info">未找到电影</div>',o.innerHTML="",void(document.getElementById("pagination").innerHTML="");displayCurrentPage(),i.innerHTML=""}else i.innerHTML=`<div class="notification is-warning">${e.message||"搜索失败"}</div>`})).catch((e=>{console.error("Search error:",e),i.innerHTML=`<div class="notification is-danger">搜索出错: ${e.message}</div>`,o.innerHTML="",document.getElementById("pagination").innerHTML=""}))}function displayPagination(){const e=`\n        <nav class="pagination is-centered" role="navigation" aria-label="pagination">\n            <a class="pagination-previous" ${1===currentPage?"disabled":""} onclick="changePage(${currentPage-1})">上一页</a>\n            <a class="pagination-next" ${currentPage===totalPages?"disabled":""} onclick="changePage(${currentPage+1})">下一页</a>\n            <ul class="pagination-list">\n                ${generatePaginationItems()}\n            </ul>\n        </nav>\n    `;document.getElementById("pagination").innerHTML=e}function generatePaginationItems(){let e=[];for(let t=Math.max(1,currentPage-2);t<=Math.min(totalPages,currentPage+2);t++)e.push(`\n            <li>\n                <a class="pagination-link ${t===currentPage?"is-current":""}" \n                   onclick="changePage(${t})">${t}</a>\n            </li>\n        `);return e.join("")}function changePage(e){e>=1&&e<=totalPages&&(currentPage=e,displayCurrentPage())}function makeTableResizable(){const e=document.querySelector(".table");if(!e)return;const t=e.querySelectorAll("th");let n,a,i,o=!1;t.forEach(((e,t)=>{const s=document.createElement("div");s.className="column-resizer",e.appendChild(s),s.addEventListener("mousedown",(t=>{o=!0,n=e,a=t.pageX,i=e.offsetWidth,document.body.style.cursor="col-resize",n.classList.add("resizing")}))})),document.addEventListener("mousemove",(e=>{if(!o)return;const t=i+(e.pageX-a);t>50&&(n.style.width=`${t}px`)})),document.addEventListener("mouseup",(()=>{if(o&&(o=!1,document.body.style.cursor="",n)){n.classList.remove("resizing");const e={};t.forEach(((t,n)=>{e[t.dataset.column]=t.style.width})),localStorage.setItem("tableColumnWidths",JSON.stringify(e))}}))}function closeModal(){ModalManager.close("editModal")}function loadNonCriticalResources(){const e=[];0!==e.length&&e.forEach((e=>{if("script"===e.type){const t=document.createElement("script");t.src=e.src,t.async=!0,document.body.appendChild(t)}else if("style"===e.type){const t=document.createElement("link");t.rel="stylesheet",t.href=e.href,document.head.appendChild(t)}}))}document.getElementById("search-input").addEventListener("input",debounce(searchMovies,300)),document.addEventListener("DOMContentLoaded",(()=>{loadTags(),loadNonCriticalResources(),loadRatingsDimensions(),setupDropdownPositioning(),initImageUpload()}));let ratingsDimensions=[];function loadRatingsDimensions(){fetch("/get_ratings_dimensions").then((e=>e.json())).then((e=>{e.success&&(ratingsDimensions=e.dimensions,createRatingForms())}))}function createRatingForms(){const e=document.createElement("div");e.className="ratings-box",e.style.display="block";const t=document.createElement("div");t.className="ratings-box-title",t.textContent="评分";const n=document.createElement("div");n.id="edit-ratings-container",n.style.display="block";const a=document.getElementById("add-ratings-container");ratingsDimensions.forEach((e=>{const t=createRatingField(e,!0);n.appendChild(t);const i=createRatingField(e,!1);a.appendChild(i)})),e.appendChild(t),e.appendChild(n);document.querySelector("#editModal .modal-card-body form").appendChild(e)}function createRatingField(e,t){const n=t?"edit-":"",a=document.createElement("div");a.className="field",a.innerHTML=`\n        <label class="label">${e.name}</label>\n        <div class="control">\n            <div class="rating" data-dimension-id="${e.id}">\n                <input type="radio" id="${n}rating-${e.id}-5" name="${n}rating-${e.id}" value="5">\n                <span title="5分">★</span>\n                <input type="radio" id="${n}rating-${e.id}-4" name="${n}rating-${e.id}" value="4">\n                <span title="4分">★</span>\n                <input type="radio" id="${n}rating-${e.id}-3" name="${n}rating-${e.id}" value="3">\n                <span title="3分">★</span>\n                <input type="radio" id="${n}rating-${e.id}-2" name="${n}rating-${e.id}" value="2">\n                <span title="2分">★</span>\n                <input type="radio" id="${n}rating-${e.id}-1" name="${n}rating-${e.id}" value="1">\n                <span title="1分">★</span>\n            </div>\n        </div>\n    `;return a.querySelectorAll(".rating span").forEach((e=>{e.addEventListener("click",(function(){const e=this.previousElementSibling;e&&(e.checked=!0,e.dispatchEvent(new Event("change")))}))})),a}function collectRatings(e=!1){const t=e?"edit-":"",n=[];return ratingsDimensions.forEach((e=>{const a=document.querySelector(`input[name="${t}rating-${e.id}"]:checked`);a&&n.push(`${e.id}:${a.value}`)})),n.join(",")}function openModal(e){document.querySelector(".modal-card-title").textContent=`编辑电影：${e.title}`;document.getElementById("editModal");const t=document.querySelector("#edit-movie-form div:has(> p.has-text-grey)");t&&t.remove(),document.getElementById("edit-title").value=e.title;const n=document.createElement("div");n.className="field",n.innerHTML=`\n        <p class="has-text-grey">\n            添加日期: ${formatDate(e.added_date)}\n        </p>\n    `;const a=document.getElementById("edit-movie-form");a.insertBefore(n,a.firstChild);const i=document.getElementById("edit-recommended").checked=1===e.recommended;i&&(i.checked=!0),document.getElementById("edit-review").value=e.review||"",loadEditTags().then((()=>{const t=document.querySelectorAll("#edit-tags .tag"),n=e.tag_names?e.tag_names.split(", "):[];t.forEach((e=>{e.classList.toggle("is-selected",n.includes(e.textContent.trim()))}))})),loadEditRatings().then((()=>{if(e.ratings){e.ratings.split(",").forEach((e=>{const[t,n]=e.split(":"),a=document.querySelector(`input[name="edit-rating-${t}"][value="${n}"]`);a&&(a.checked=!0)}))}})),ModalManager.open("editModal")}async function loadEditTags(){try{const e=await fetch("/get_tags"),t=await e.json();if(t.success){const e=document.getElementById("edit-tags");e.innerHTML="",t.data.forEach((t=>{const n=document.createElement("span");n.className="tag",n.textContent=t,n.onclick=()=>toggleTag(n),e.appendChild(n)}))}}catch(e){console.error("加载标签失败:",e)}}async function loadEditRatings(){try{const e=await fetch("/get_ratings_dimensions"),t=await e.json();if(t.success){const e=document.createElement("div");e.className="ratings-box";const n=document.createElement("div");n.className="ratings-box-title",n.textContent="评分",e.appendChild(n);const a=document.createElement("div");a.id="edit-ratings-container",t.dimensions.forEach((e=>{const t=createRatingField(e,!0);a.appendChild(t)})),e.appendChild(a);const i=document.querySelector("#editModal .modal-card-body form"),o=i.querySelector(".field:last-of-type"),s=i.querySelector(".ratings-box");s&&s.remove(),i.insertBefore(e,o.nextSibling)}}catch(e){console.error("加载评分维度失败:",e)}}function deleteMovie(){if(!confirm("确定要删除这部电影吗？"))return;saveSearchState();const e=document.getElementById("edit-title").value;fetch(`/api/movies/${encodeURIComponent(e)}`,{method:"DELETE"}).then((e=>e.json())).then((e=>{if(!e.success)throw new Error(e.message||"删除失败");closeModal(),restoreSearchState(),searchMovies(),showToast(e.message||"删除成功","success")})).catch((e=>{console.error("Error:",e),showToast(e.message||"删除失败","error")}))}let searchState={page:1,title:"",ratingDimension:"",minRating:"",selectedTags:[]};function saveSearchState(){searchState={page:currentPage,title:document.getElementById("search-input").value.trim(),ratingDimension:document.getElementById("rating-dimension-filter").value,minRating:document.getElementById("min-rating-filter").value,selectedTags:Array.from(document.querySelectorAll("#tags-filter .tag.is-selected")).map((e=>e.textContent))}}function restoreSearchState(){document.getElementById("search-input").value=searchState.title,document.getElementById("rating-dimension-filter").value=searchState.ratingDimension,document.getElementById("min-rating-filter").value=searchState.minRating;document.querySelectorAll("#tags-filter .tag").forEach((e=>{searchState.selectedTags.includes(e.textContent)&&e.classList.add("is-selected")})),currentPage=searchState.page}function updateMovie(){const e=document.getElementById("edit-movie-form"),t=document.getElementById("edit-title").value;saveSearchState();const n={title:t,recommended:document.getElementById("edit-recommended").checked?1:0,review:e.querySelector('[id="edit-review"]').value,tags:Array.from(document.querySelectorAll("#edit-tags .tag.is-selected")).map((e=>e.textContent)).join(","),ratings:collectRatings(!0)};fetch(`/api/movies/${encodeURIComponent(t)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then((e=>e.json())).then((e=>{e.message?(document.getElementById("editModal").classList.remove("is-active"),restoreSearchState(),searchMovies()):alert(e.error||"更新失败")})).catch((e=>{alert(`更新失败: ${e}`)}))}function displayCurrentPage(){const e=document.getElementById("search-results");if(e.innerHTML="",0===allMovies.length)return e.innerHTML='<div class="notification is-info">没有找到电影</div>',void(document.getElementById("pagination").innerHTML="");const t=10*(currentPage-1),n=t+10,a=allMovies.slice(t,n),i=document.createElement("div");i.className="table-container";const o=document.createElement("table");o.className="table is-fullwidth is-striped is-hoverable";const s=document.createElement("thead"),r=document.createElement("tr"),l=getStoredColumnWidths();r.innerHTML=`\n        <th data-column="title" style="width: ${l.title}">电影名称</th>\n        <th data-column="recommended" style="width: ${l.recommended}">推荐</th>\n        <th data-column="review" style="width: ${l.review}">评价</th>\n        <th data-column="tags" style="width: ${l.tags}">标签</th>\n        <th data-column="ratings" style="width: ${l.ratings}">评分</th>\n        <th data-column="action" style="width: ${l.action}">操作</th>\n    `,s.appendChild(r),o.appendChild(s);const c=document.createElement("tbody");a.forEach((e=>{const t=document.createElement("tr"),n=e.ratings?e.ratings.split(",").map((e=>{const[t,n]=e.split(":");return{dimensionId:t.toString(),value:parseInt(n)}})).filter((e=>e.value>0)):[],a=n.length>0?n.map((e=>{const t=ratingsDimensions.find((t=>t.id.toString()===e.dimensionId));return t?`\n                        <div class="rating-item">\n                            <span class="dimension-name">${t.name}:</span>\n                            <span class="stars">${renderStars(e.value)}</span>\n                        </div>\n                    `:""})).join(""):"",i=n.length>0?`<div class="dropdown is-hoverable">\n                <div class="dropdown-trigger">\n                    <button class="button is-small">\n                        <span>查看评分</span>\n                    </button>\n                </div>\n                <div class="dropdown-menu" role="menu">\n                    <div class="dropdown-content">\n                        ${a}\n                    </div>\n                </div>\n            </div>`:'<button class="button is-small" disabled>暂无评分</button>';t.innerHTML=`\n            <td class="hoverable" title="${e.title}">${e.title}</td>\n            <td>\n                <svg width="20" height="20" fill="${e.recommended?"#ff7b00":"#515151"}" stroke="none" aria-label="${e.recommended?"推荐":"不推荐"}">\n                    <use href="/static/sprite.svg#${e.recommended?"recommend-light-icon":"recommend-icon"}"></use>\n                </svg>\n            </td>\n            <td class="hoverable" title="${e.review||""}">${e.review||""}</td>\n            <td class="hoverable" title="${e.tag_names||""}">${e.tag_names||""}</td>\n            <td class="ratings-cell">${i}</td>\n            <td>\n                <button class="button is-small is-info" onclick='openModal(${JSON.stringify(e)})'>\n                    编辑\n                </button>\n            </td>\n        `,c.appendChild(t)})),o.appendChild(c),i.appendChild(o),e.appendChild(i),updatePagination(),makeTableResizable(),setupDropdownPositioning()}function setupDropdownPositioning(){document.addEventListener("mouseover",(function(e){const t=e.target.closest(".dropdown");if(!t)return;const n=t.querySelector(".dropdown-menu");if(!n)return;const a=window.innerHeight,i=t.getBoundingClientRect(),o=n.offsetHeight,s=a-i.bottom;n.style.bottom="auto",n.style.top="auto",s<o&&i.top>o?(n.style.bottom="100%",n.style.marginBottom="5px"):(n.style.top="100%",n.style.marginTop="5px"),n.style.left="0",n.style.right="auto";n.getBoundingClientRect().right>window.innerWidth&&(n.style.left="auto",n.style.right="0")}))}function formatDate(e){return new Date(e).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(/\//g,"-")}function renderStars(e){return"★".repeat(e)+"☆".repeat(5-e)}function updatePagination(){const e=document.getElementById("pagination");if(!e)return;let t='<nav class="pagination is-centered" role="navigation" aria-label="pagination">';t+=`\n        <a class="pagination-previous" ${currentPage<=1?"disabled":""} \n           onclick="${currentPage>1?"changePage("+(currentPage-1)+")":""}"}>\n           上一页\n        </a>\n    `,t+=`\n        <a class="pagination-next" ${currentPage>=totalPages?"disabled":""} \n           onclick="${currentPage<totalPages?"changePage("+(currentPage+1)+")":""}"}>\n           下一页\n        </a>\n    `,t+='<ul class="pagination-list">';currentPage>3&&(t+=`\n            <li><a class="pagination-link" onclick="changePage(1)">1</a></li>\n            ${currentPage>4?'<li><span class="pagination-ellipsis">&hellip;</span></li>':""}\n        `);for(let e=Math.max(1,currentPage-2);e<=Math.min(totalPages,currentPage+2);e++)t+=e===currentPage?`<li><a class="pagination-link is-current" aria-current="page">${e}</a></li>`:`<li><a class="pagination-link" onclick="changePage(${e})">${e}</a></li>`;currentPage<totalPages-2&&(t+=`\n            ${currentPage<totalPages-2-1?'<li><span class="pagination-ellipsis">&hellip;</span></li>':""}\n            <li><a class="pagination-link" onclick="changePage(${totalPages})">${totalPages}</a></li>\n        `),t+="</ul></nav>",e.innerHTML=t}function initImageUpload(){const e=document.getElementById("image-upload-area"),t=document.getElementById("image-input"),n=e.querySelector(".image-preview-container"),a=e.querySelector(".upload-placeholder");let i=[];function o(){a.style.display=i.length>0?"none":"block"}function s(e){const t=e.filter((e=>e.type.startsWith("image/")));if(0===t.length)return void alert("请选择图片文件");const n=t.filter((e=>!i.some((t=>t.name===e.name&&t.size===e.size&&t.type===e.type))));0!==n.length?(i=[...i,...n],n.forEach((e=>{const t=new FileReader;t.onload=e=>{addImagePreview(e.target.result),o()},t.readAsDataURL(e)})),o()):alert("所选图片已存在")}n.addEventListener("click",(e=>{if(e.target.classList.contains("delete-image")){e.preventDefault(),e.stopPropagation();const t=e.target.closest(".preview-item");if(t){t.remove();const e=Array.from(n.children).indexOf(t);i.splice(e,1),o()}}})),e.addEventListener("click",(()=>{t.click()})),e.addEventListener("dragover",(t=>{t.preventDefault(),e.classList.add("dragover")})),e.addEventListener("dragleave",(()=>{e.classList.remove("dragover")})),e.addEventListener("drop",(t=>{t.preventDefault(),e.classList.remove("dragover"),s(Array.from(t.dataTransfer.files))})),t.addEventListener("change",(()=>{s(Array.from(t.files))})),window.resetImageUpload=()=>{i=[],n.innerHTML="",a.style.display="block"},window.getUploadedFiles=()=>i}function addImagePreview(e){const t=document.querySelector(".image-preview-container"),n=document.createElement("div");n.className="preview-item",n.innerHTML=`\n        <img src="${e}" alt="预览图">\n        <button class="delete-image">×</button>\n    `,t.appendChild(n)}document.getElementById("add-movie-form").addEventListener("submit",(async function(e){e.preventDefault();const t=new FormData(this),n=document.getElementById("add-movie-message");try{const e=window.getUploadedFiles()||[];console.log("选择的文件:",e);const a=[];for(const n of e){const e=new FormData;e.append("image",n),e.append("title",t.get("title"));const i=await fetch("/upload_image",{method:"POST",body:e}),o=await i.json();if(console.log("上传结果:",o),!o.success)throw new Error(o.message||"图片上传失败");a.push(o.filename)}console.log("收集的文件名:",a);const i={title:t.get("title"),recommended:"1"===t.get("recommended"),review:t.get("review"),tags:Array.from(document.querySelectorAll("#add-tags .tag.is-selected")).map((e=>e.textContent)).join(","),ratings:collectRatings(),image_filenames:a.join(",")};console.log("最终提交的数据:",i);const o=await fetch("/api/movies",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),s=await o.json();s.message?(n.innerHTML=`<div class="notification is-success">${s.message}</div>`,this.reset(),document.querySelectorAll("#add-tags .tag").forEach((e=>e.classList.remove("is-selected"))),window.resetImageUpload(),setTimeout((()=>{n.innerHTML=""}),3e3)):n.innerHTML=`<div class="notification is-danger">${s.error||"添加失败"}</div>`}catch(e){console.error("Error:",e),n.innerHTML=`<div class="notification is-danger">添加失败: ${e.message}</div>`}})),document.addEventListener("DOMContentLoaded",(function(){loadFilters(),document.getElementById("rating-dimension-filter").addEventListener("change",searchMovies),document.getElementById("min-rating-filter").addEventListener("change",searchMovies),document.getElementById("search-button").addEventListener("click",searchMovies),document.getElementById("search-input").addEventListener("keypress",(function(e){"Enter"===e.key&&searchMovies()})),document.getElementById("wtl-input").addEventListener("keypress",(function(e){"Enter"===e.key&&searchWtl()})),document.getElementById("emby-search-input").addEventListener("keypress",(function(e){"Enter"===e.key&&searchEmby()})),document.getElementById("duplicate-input").addEventListener("keydown",(function(e){e.ctrlKey&&"Enter"===e.key&&checkDuplicates()}));const e=document.querySelector("#add-movie-form"),t=e.querySelector('input[name="title"]'),n=e.querySelectorAll(".collapsible-box");n.forEach((e=>{e.querySelector(".box-header").addEventListener("click",(()=>{const t=e.querySelector(".box-content"),n=e.querySelector(".collapse-icon");t.classList.toggle("expanded"),n.classList.toggle("collapsed")}))})),t&&t.addEventListener("input",(function(){const e=""!==this.value.trim();n.forEach((t=>{const n=t.querySelector(".box-content"),a=t.querySelector(".collapse-icon");e?(n.classList.add("expanded"),a.classList.remove("collapsed")):(n.classList.remove("expanded"),a.classList.add("collapsed"))}))}))}));